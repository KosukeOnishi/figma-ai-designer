<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      color: #333;
      padding: 16px;
      background: #fff;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .logo {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 16px;
    }

    .title {
      font-size: 16px;
      font-weight: 600;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ccc;
    }

    .status-dot.connected {
      background: #22c55e;
    }

    .status-dot.connecting {
      background: #f59e0b;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-text {
      flex: 1;
    }

    .status-label {
      font-weight: 500;
    }

    .status-detail {
      color: #666;
      font-size: 11px;
    }

    .section {
      margin-bottom: 16px;
    }

    .section-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #666;
      text-transform: uppercase;
      font-size: 10px;
      letter-spacing: 0.5px;
    }

    .info-box {
      background: #f0f4ff;
      border: 1px solid #c7d2fe;
      border-radius: 8px;
      padding: 12px;
      font-size: 11px;
      line-height: 1.5;
    }

    .info-box code {
      background: #e0e7ff;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 10px;
    }

    .log-container {
      background: #1a1a1a;
      border-radius: 8px;
      padding: 12px;
      max-height: 120px;
      overflow-y: auto;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 10px;
      color: #a0a0a0;
    }

    .log-entry {
      margin-bottom: 4px;
      word-break: break-all;
    }

    .log-entry.info { color: #60a5fa; }
    .log-entry.success { color: #22c55e; }
    .log-entry.error { color: #ef4444; }
    .log-entry.warn { color: #f59e0b; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5a67d8;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    .footer {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
      font-size: 10px;
      color: #9ca3af;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">AI</div>
    <div class="title">AI Designer</div>
  </div>

  <div class="status">
    <div class="status-dot" id="statusDot"></div>
    <div class="status-text">
      <div class="status-label" id="statusLabel">Connecting...</div>
      <div class="status-detail" id="statusDetail">Waiting for MCP server</div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">How to Use</div>
    <div class="info-box">
      <p><strong>Step 1:</strong> Keep this plugin open in Figma</p>
      <p style="margin-top: 10px;"><strong>Step 2:</strong> Add to your AI client's MCP config:</p>
      <p style="margin-top: 6px; padding: 8px; background: #e0e7ff; border-radius: 4px;">
        <code>"figma-ai-designer": {<br>&nbsp;&nbsp;"command": "npx",<br>&nbsp;&nbsp;"args": ["figma-ai-designer"]<br>}</code>
      </p>
      <p style="margin-top: 10px;"><strong>Step 3:</strong> Ask your AI to create components!</p>
      <p style="margin-top: 4px; font-style: italic; color: #5a67d8;">"Create a login form with email, password, and submit button"</p>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Activity Log</div>
    <div class="log-container" id="logContainer">
      <div class="log-entry info">Initializing plugin...</div>
    </div>
  </div>

  <div class="actions">
    <button class="btn btn-primary" id="reconnectBtn" disabled>Reconnect</button>
    <button class="btn btn-secondary" id="clearLogBtn">Clear Log</button>
  </div>

  <div class="footer">
    AI Designer v0.1.0 | WebSocket: ws://localhost:51847
  </div>

  <script>
    const WS_URL = 'ws://localhost:51847';
    let ws = null;
    let reconnectTimeout = null;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 10;
    const RECONNECT_DELAY = 3000;

    // UI Elements
    const statusDot = document.getElementById('statusDot');
    const statusLabel = document.getElementById('statusLabel');
    const statusDetail = document.getElementById('statusDetail');
    const logContainer = document.getElementById('logContainer');
    const reconnectBtn = document.getElementById('reconnectBtn');
    const clearLogBtn = document.getElementById('clearLogBtn');

    // Logging
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const time = new Date().toLocaleTimeString();
      entry.textContent = `[${time}] ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    // Status update
    function setStatus(status, label, detail) {
      statusDot.className = `status-dot ${status}`;
      statusLabel.textContent = label;
      statusDetail.textContent = detail;
    }

    // Connect to WebSocket server
    function connect() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        return;
      }

      setStatus('connecting', 'Connecting...', `Attempt ${reconnectAttempts + 1}`);
      log(`Connecting to MCP server at ${WS_URL}...`);

      try {
        ws = new WebSocket(WS_URL);

        ws.onopen = () => {
          reconnectAttempts = 0;
          setStatus('connected', 'Connected', 'MCP server connected');
          log('Connected to MCP server', 'success');
          reconnectBtn.disabled = true;

          // Send connected message to server
          ws.send(JSON.stringify({
            id: 'connected_' + Date.now(),
            type: 'connected',
            payload: {
              pluginVersion: '0.1.0',
              figmaVersion: 'figma'
            }
          }));

          // Also notify plugin code
          parent.postMessage({ pluginMessage: { type: 'connected' } }, '*');
        };

        ws.onclose = () => {
          setStatus('', 'Disconnected', 'MCP server not connected');
          log('Disconnected from MCP server', 'warn');
          reconnectBtn.disabled = false;
          scheduleReconnect();
        };

        ws.onerror = (error) => {
          log('WebSocket error: ' + (error.message || 'Connection failed'), 'error');
        };

        ws.onmessage = (event) => {
          try {
            const message = JSON.parse(event.data);
            log(`Received: ${message.type}`, 'info');

            // Forward message to plugin code
            parent.postMessage({ pluginMessage: message }, '*');
          } catch (error) {
            log('Failed to parse message: ' + error.message, 'error');
          }
        };
      } catch (error) {
        log('Failed to connect: ' + error.message, 'error');
        scheduleReconnect();
      }
    }

    // Schedule reconnection
    function scheduleReconnect() {
      if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
        log('Max reconnection attempts reached', 'error');
        setStatus('', 'Connection Failed', 'Click Reconnect to try again');
        reconnectBtn.disabled = false;
        return;
      }

      if (reconnectTimeout) {
        clearTimeout(reconnectTimeout);
      }

      reconnectAttempts++;
      reconnectTimeout = setTimeout(connect, RECONNECT_DELAY);
    }

    // Handle messages from plugin code
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === 'plugin_ready') {
        log('Plugin initialized', 'success');
        connect();
        return;
      }

      // Forward response to WebSocket server
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(msg));
        log(`Sent: ${msg.type}`, 'success');
      } else {
        log('Cannot send - not connected', 'error');
      }
    };

    // Button handlers
    reconnectBtn.addEventListener('click', () => {
      reconnectAttempts = 0;
      connect();
    });

    clearLogBtn.addEventListener('click', () => {
      logContainer.innerHTML = '';
      log('Log cleared', 'info');
    });

    // Initial state
    setStatus('', 'Initializing', 'Starting plugin...');
  </script>
</body>
</html>
